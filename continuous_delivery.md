## 持续集成与持续交付

### 1. 版本控制系统

版本控制系统又称源代码管理系统或源代码托管系统，是指一种记录一个或若干文件内容变化，以便将来查阅特定版本修订情况的系统。

##### 版本控制系统应包含以下基本功能：

——版本仓库又称源代码仓库，版本仓库应支持浏览、查阅、归档

——为版本仓库指定成员，并根据可访问、可读取、可写入等不同能力将成员划分为管理员、负责人、开发者、协作者等不同角色，并能在不同对象上（如团队、项目等）定义

——支持浏览、查阅、创建和删除分支，可根据分支查看变更历史，并查看分支对应的版本文件

——能够在分支上定义合并策略，限制不同开发人员在分支上的合并权限

——可查看某个变更的当前全部版本文件，并将版本文件拉取到本地

——可将本地修改提交到版本仓库，完成变更

——支持在线对比两个不同变更之间的文件差异，查看变更的历史记录以及变更之间的关联关系。并可将一个或多个变更创建为合并评审，用于合并到待合并分支

——查看合并评审的历史列表，以及每个合并评审引入的变更，可设置经过评审后才可合并

——支持将某个变更标识为Tag，并作为基线管理

——查看基线对应的版本文件，并能将对应的版本文件下载到本地

——查看不同变更间、不同基线间、变更与基线间、分支与基线间的文件差异

——变更被提交时，提供Hooks用于触发自动化集成和检测

——发起代码审查，邀请审查人在不同时间和地点查看版本差异并给出意见

——提供实时和定时的备份机制，可使用备份还原版本仓库

——应唯一确定访问账号身份，保证无法越权访问

——应能够保留访问记录和危险操作记录，用于审计回溯

——应支持如https / SSH等加密传输方式，保证传输过程的网络包被截获后无法轻易解密

——应为变更、合并和代码审查提供Hook，用于触发自动化流程

——应提供CI/CD中基本功能的API，用于其他系统调用接入


##### 版本控制系统可以包含以下高级功能：

——复刻版本库

——建立团队或路径等方式，并在其中指派不同角色的成员，将版本仓库按一定模式归类存放

——更改版本仓库的可见性为全员共享或部分可见

——支持二进制文件的快速存储，如Git LFS

——限制仓库总大小，限制仓库的单文件大小，对限制额度进行缩小或提额

——定义分支创建规则，对分支的创建进行限定，在分支上定义角色，指认分支的管理员，定义读取、写入和合并权限

——针对变更进行讨论

——合并评审可根据代码扫描、持续集成与自动化测试系统反馈情况，阻止有风险的版本合入

——定义基线的命名规则，阻止不符合规则的基线创建

——对代码审查进行数据度量

——审查人能在移动终端查看代码审查、讨论并给出意见

——能与主流的即时通讯服务或团队协同工具集成，提供实时的消息通知

——同一个版本仓库能够支持多份存储写入，当存储故障时可切换备份存储

——同一个版本仓库能够提供多地存储，在有多地访问需求时，能提供就近访问

——大量复刻并修改同一版本仓库时，能让存储容量不随复刻数线性增长

——支持OAuth等安全的三方认证能力，保证需求敏捷、持续集成、持续交付、代码检测、自动化测试等工具在访问版本资源时，访问权限受到当前操作人角色权限的限制

——提供研发生命周期中所需功能的API，用于其它系统深度集成

——提供会话墙能力（又名事件墙、动态墙），可提供项目维度和团队维度的动态墙用于汇聚研发过程有关的消息和事件，使用会话的形式聚合研发过程中发生的事件与关键结点，并可使用移动终端查阅。

——会话墙能力可允许需求敏捷、持续集成、持续交付、代码检测、自动化测试等工具调用


### 2、构建与持续集成

构建是将软件源代码通过构建工具转换为可执行程序的过程，一般包含编译和链接两个步骤，将高级语言代码转换为可执行的机器代码并进行相应的优化，提升运行效率。

持续集成是软件构建过程中的一个最佳实践，在版本控制的基础上，通过频繁的代码提交，自动化构建和自动化测试，加快软件集成周期和问题反馈速度，从而及时验证系统可用性。

##### 基本功能：

——构建过程的触发方式支持手动、定时、、GIT或SVN事件等多种方式；

——构建环境调度需支持MacOS或Linux或Windows等主流操作系统；

——构建环境需支持可定制的运行最长时间（超时时间）；

——构建任务可通过配置文件或web可视化定义；

——构建触发需支持变量传入；

——构建任务支持GIT或SVN等仓库的代码拉取；

——构建环境和任务的初始化配置模板或脚本的存储支持版本管理，且可配置标签；

——构建结果需支持日志可视化且日志可导出；

——构建过程中的产出文件或日志可归档到制品仓库，可提供持久化查询；

——支持设定策略用于构建失败的情况；

——构建与持续集成可设定多种通知方式，支持email、短信、电话以及即时通讯等；

——构建任务需支持串行以及并行的编排方式；

——构建任务的全生命周期支持详尽的报告输出；

——构建支持多种源代码语言；

——构建支持与制品库联动，可拉取指定的编译依赖包；

——持续集成实践支持编译构建、自动化测试以及静态代码扫描等阶段；

——支持测试和代码检查产出的指标作为质量红线的卡点阈值，并在构建流程加入关卡等方式提升版本质量；


##### 高级功能：

——基于GIT事件触发的方式，支持监听分支、排除分支的规则，以及支持push\tag\PR等事件；

——定时触发支持源代码未更新时不触发；手动触发支持构建参数的输入以及确发执行时使用最近一次构建参数值；

——GIT代码仓库拉取支持submodule;

——构建任务中GIT仓库代码拉取需支持按分支、tag、commit ID等方式。

——构建任务中的仓库拉取策略需支持revert update、fresh checkout、increment update等；

——构建任务的编译脚本需支持设置全局变量，供构建任务全生命周期调用；

——支持当代码PR事件触发时所运行的持续集成任务，将结果回写到代码仓库；

——构建的全生命周期可支持随时远程登录调试；

——针对长编译任务的工程，需支持分布式编译；

——基于Linux类型的构建环境需支持编译时可调度开机或启动，编译结束后自动关机或销毁；

——构建任务的工作空间需支持严格的安全隔离；

——构建环境需支持全生命周期的异常监控；

——支持虚拟化技术生产出构建环境；

——构建任务的锁定支持同时运行多个构建任务、同一时间最多只能运行一个构建任务以及任何触发方式都无法运行的三种策略；

——持续集成作为研运一体化的基础服务，需提供API为上层SaaS服务；


### 4. 流水线

流水线是编排自动化流程的实现。

##### 应包含以下基本功能：

——支持配置编排流水线，可按需定制步骤及任务

——支持对接调度其他服务作为流水线任务，包括但不限于代码拉取、代码检查、编译构建、部署、测试、发布等

——支持跳转其他服务查看任务详情

——支持多种自动触发方式，包括但不限于定时触发、代码提交触发等

——支持流水线中的任务并行执行、串行执行

——支持配置任务参数、自定义任务参数

——支持查看流水线的实时执行状态、执行结果、执行历史记录

——支持停止执行中的流水线

——支持查看任务执行状态、执行结果、执行日志

——支持数据统计，包括但不限于流水线总数、成功率、健康度

——支持流水线中的任务自动流转、手动流转

——支持下载构建包

——支持流水线的级联调度

——支持流水线质量管理，包括但不限于质量门禁、流水线及任务的健康度评估等

##### 可以包含以下高级功能：

——支持人工审批

——支持白屏化配置

——支持流水线并行执行、串行执行

——支持查到流水线的一次运行所对应的当时的流水线配置

——支持流水线执行时的选择性跳过

——支持保存流水线执行中的产出物，包括但不限于测试报告，单元测试报告，测试覆盖率报告等

——支持设置流水线任务时长限制和超时处理

——支持流水线的模板

——支持定义执行超时时间

——支持源码多分支管理策略的流水线场景

——支持动态可伸缩的执行环境

——支持流水线内容及结果的通知，包括但不限于及时消息、邮件、短信服务、聊天工具等

——支持以代码方式记录流水线配置

### 5. 制品管理

制品管理是对软件研发过程中生成的产物的管理，一般作为最终交付物完成发布和交付。比如jar包、zip包、rpm包、docker镜像等。

##### 应包含以下基本功能：

——支持至少一种制品类型

——通过界面及客户端添加制品

——为制品添加版本信息等元数据信息,具备版本管理能力

——使用制品的审计日志

——基本的权限管理

——检索制品

——备份和恢复

##### 可以包含以下高级功能：

——支持多种制品类型

——代理其他制品库

——基于元数据信息实现制品的安全管控、熔断机制、晋级

——通过开放API与持续交付系统集成

——通过关键字、坐标数据、CheckSum等多种方式检索制品

——基于角色的权限管理

——基于自定义策略的访问控制

——制品文件安全扫描

——分析和查看制品依赖关系

——基于CheckSum的制品去重存储

——制品分发支持大规模并发

——自定义制品清理/归档策略 

——制品存储支持多种方式，不依赖于特定厂商或存储源

### 6. 部署管理

部署管理是DevOps持续交付中的一个重要环节，它借助自动化工具，实现制品到目标环境的自动化部署，提升软件交付的效率。

##### 应包含以下基本功能：

——支持部署的基本权限管理；

——支持批量并发的部署能力

——支持按批次分阶段部署

——支持部署任务定时触发

——支持布署任务的参数配置初始化

——支持部署节点的自定义脚本

——支持快速回滚的能力

——支持布署对象的基本统一管理；

——支持对部署结果的自定义检查；

——支持部署最终结果的通知

——支持部署历史任务的查看

##### 可以包含以下高级功能：

——支持与周边基础资源平台的联动，对部署对象进行集中管理

——支持调度编排能力，包含但不限于并行、分支、上下文传参等功能

——支持各项部署功能的开放API，包含但不限于部署任务的执行、状态查询、结果返回等，为上层提供调用

### 7. 发布管理

发布管理是产品从测试完成到生产环境可见的一个过程。

##### 应包含以下基本功能：

——发布权限，应具备可控的发布权限管理能力

——发布定义，发布定义应包含但不限于制定发布审批工作流、确定发布通知策略等

——发布策略，发布策略应包含但不限于滚动发布、蓝绿发布、金丝雀发布等

——发布执行，具备人工发布或自动化部署发布的能力

——发布确认，通过对发布的确认，判断发布的结果，应具备快速回滚发布的能力


##### 可以包含以下高级功能：
——可具备自动生成release notes的能力

——发布的事件，可通过webhook或event等方式进行通知

——可根据发布窗口制定不同的发布审批工作流

——发布历史，应可追溯到制品版本和代码版本

### 8. 环境管理

环境管理是一种配置管理活动，确保应用在多个环境之间达到持续交付的目的。

##### 应包含以下基本功能：

——可以定义不同的环境类型，如开发、测试、预发布及生产环境；

——可以对不同类型的环境下的不同集群进行管理，如：生产集群下的正式和备份集群等等；

——可以定义不同的环境依赖资源信息及其配置，比如主机、容器集群、DNS、中间件、其他基础设施服务等等；

——可以根据环境的配置快速生成环境；

——支持环境配置信息的版本控制和持久化存储；

——可以支持应用运行的环境是静态主机集群或者是动态的容器集群；

——可以支持不同的应用有不同的基础设施及服务依赖；

——可以支持不同的资源对象分块分步构建，比如说构建基础设施、构建中间件或者操作系统环境等等；

——支持针对不同环境采用不同的构建方法和技术，包括但不限于虚拟化、容器等等；

——可以支持环境的配置信息与应用或者项目关联；

——对环境提供监控功能；

##### 可以包含以下高级功能：

可以包含以下高级功能：

——提供与不同的配置管理工具对接功能；

——提供与不同制品构件库对接功能，比如说maven仓库和容器仓库artifactory、harbor等等（1101）；

——提供开放式的API供外围平台编排调用；

——支持不同测试环境实例复用相同的基础设施（如应用运行时依赖的其他应用)，而不互相干扰。

——提供所有环境的变更日志和审计功能；

——提供环境配置信息的权限控制；

——提供测试验证的工具来验证环境的有效性；

### 9. 数据管理

数据管理是指在应用的测试段和生产部署流水线过程中，对测试及生产数据进行自动化、规范化的组织管理，确保在测试及部署阶段数据安全性、可靠性及管理时效的提升。

##### 应包含以下基本功能：

——不同环境/租户下的资源需要隔离；

——能够快速回收环境，释放关联资源

——支持对数据的持久化及DDL、DML的数据查询、变更等管理操作

——提供对数据库实例创建和初始化的自动化能力

——不同数据管理账号的权限隔离

——支持按照指定规则自动创建、提取或过滤测试数据

——支持数据容灾功能，包括但不限于通过分布式、主从式等方式实现

——支持对数据的全量、增量方式备份，数据备份应包括测试和生产数据

——兼容不同格式数据源的导入、导出操作

##### 可以包含以下高级功能：

——支持增加对生产数据查询、变更的操作审核环节

——支持对生产数据敏感内容的脱敏处理

——支持对数据管理运行环境的性能监控

——支持按需进行的数据闪回操作

### 10. 应用配置管理

应用配置是指应用启动或动态运行时影响应用行为的配置项，典型例子如数据库连接串(含用户名密码)，本地服务线程池数，RPC连接超时时间设置，三方软件LicenseKey，等。应用配置管理，是对应用配置进行集中式管理的系统和方法。采用应用配置管理，可以让配置发布有效解耦程序开发，程序发布等流程，并让程序能动态响应配置的变更，提高DevOps效率。

##### 应包含以下基本功能：

——配置的最小粒度应对应单一配置ID，其内容应不限于KV，Json, XML等格式，用户应能自由配置。

——配置内容大小应有限制，但是不宜太小，如应超过100KB以上。

——配置应能基于租户，分组，或其他不同粒度规则进行隔离。

——对配置的访问应有鉴权，以控制账号对相关配置项的读写权限操作。

——应提供相应程序接口供应用程序实现读、写配置的功能。

——应提供相应程序接口供应用程序实现配置订阅的功能，如配置变更，则程序可在短时间内做出响应。

——应用程序应可以基于各类语言如java, go, node, c++等多语言SDK来操作配置。

——应用配置管理应能和各类CI/CD工具集成，如github，等。

##### 可以包含以下高级功能：

可以包含以下高级功能：

——配置发布时应支持灰度发布，如根据某类机器的IP或某类机器的Label。

——应提供配置订阅监控，可查看配置被哪些机器订阅。

——配置应能区分版本，不同版本之间能一键回滚，以降低配置发错的风险。

——配置管理应能充分集成各类加密工具，如AWS KMS，Aliyun KMS，Hashcorp Vault，（不应出现具体产品1101）以保证配置安全性。

——配置管理中心以成为系统单点，如管理中心宕机，应用应能正常运行。(但新配置不能发布)
